<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GitHub Follow Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet" />
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #080c10;
  --surface:  #0d1117;
  --surface2: #131a22;
  --surface3: #1a2332;
  --border:   #1e2d3d;
  --border2:  #253545;
  --accent:   #00d9a3;
  --blue:     #388bfd;
  --danger:   #f85149;
  --warn:     #ffa657;
  --purple:   #bc8cff;
  --text:     #cdd9e5;
  --text2:    #768a9e;
  --text3:    #3d5266;
  --mono:     'IBM Plex Mono', monospace;
  --sans:     'Outfit', sans-serif;
  --r:        10px;
}

html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(56,139,253,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(56,139,253,0.025) 1px, transparent 1px);
  background-size: 44px 44px;
  pointer-events: none; z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 2rem 1.25rem 5rem; }

/* HEADER */
.header { display: flex; align-items: center; gap: 14px; margin-bottom: 2rem; }

.logo-wrap {
  width: 46px; height: 46px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent) 0%, var(--blue) 100%);
  border-radius: 13px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 28px rgba(0,217,163,0.22), 0 0 60px rgba(56,139,253,0.1);
}
.logo-wrap svg { width: 25px; height: 25px; fill: #080c10; }

.header-text h1 { font-family: var(--mono); font-size: 1.3rem; font-weight: 700; color: #fff; letter-spacing: -0.02em; }
.header-text h1 .gr { background: linear-gradient(90deg, var(--accent), var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.header-text p { font-size: 0.78rem; color: var(--text2); margin-top: 3px; font-weight: 300; }
.header-pill { margin-left: auto; font-family: var(--mono); font-size: 0.62rem; padding: 4px 10px; border-radius: 99px; border: 1px solid var(--border2); color: var(--text3); white-space: nowrap; }

/* CONFIG CARD */
.config-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 1.5rem; margin-bottom: 1.25rem;
  position: relative; overflow: hidden;
}
.config-card::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(0,217,163,0.35), rgba(56,139,253,0.25), transparent);
}

.fields-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
@media(max-width:560px) { .fields-row { grid-template-columns: 1fr; } }

.field label { display: block; font-family: var(--mono); font-size: 0.62rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 5px; }
.input-wrap { position: relative; }
.field input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 9px 38px 9px 12px;
  color: var(--text); font-family: var(--mono); font-size: 0.82rem;
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;
}
.field input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,217,163,0.07); }
.field input::placeholder { color: var(--text3); }

.eye-btn {
  position: absolute; right: 9px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--text2); cursor: pointer;
  font-size: 0.8rem; padding: 3px; line-height: 1; transition: color 0.2s;
}
.eye-btn:hover { color: var(--text); }

.hint { margin-top: 5px; font-size: 0.68rem; color: var(--text3); line-height: 1.5; }
.hint a { color: var(--blue); text-decoration: none; }
.hint a:hover { text-decoration: underline; }
.hint code { background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 1px 5px; font-family: var(--mono); font-size: 0.65rem; }

.config-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

/* BUTTONS */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 9px 18px; border-radius: var(--r);
  font-family: var(--mono); font-size: 0.78rem; font-weight: 600;
  cursor: pointer; border: none; transition: all 0.15s; white-space: nowrap;
}
.btn:disabled { cursor: not-allowed; opacity: 0.4; transform: none !important; }

.btn-primary { background: linear-gradient(135deg, var(--accent), #00b888); color: #060a0d; box-shadow: 0 0 18px rgba(0,217,163,0.18); }
.btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,217,163,0.28); }

.btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
.btn-danger:hover:not(:disabled) { background: rgba(248,81,73,0.09); }

.btn-success { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-success:hover:not(:disabled) { background: rgba(0,217,163,0.09); }

.btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
.btn-ghost:hover:not(:disabled) { border-color: var(--text2); color: var(--text); }

.btn-sm { padding: 5px 12px; font-size: 0.7rem; }

/* PROGRESS */
.progress-wrap { margin-top: 0.9rem; }
.progress-track { height: 3px; background: var(--border); border-radius: 99px; overflow: hidden; margin-bottom: 5px; }
.progress-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--blue), var(--accent)); }
.progress-label { font-family: var(--mono); font-size: 0.68rem; color: var(--text2); }

/* ERROR */
.error-box { background: rgba(248,81,73,0.07); border: 1px solid rgba(248,81,73,0.22); border-radius: var(--r); padding: 9px 13px; color: var(--danger); font-family: var(--mono); font-size: 0.75rem; margin-top: 0.9rem; display: none; }
.error-box.show { display: block; }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 1rem; }
@media(max-width:640px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
@media(max-width:400px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 12px 14px; }
.stat-num { font-family: var(--mono); font-size: 1.6rem; font-weight: 700; line-height: 1; }
.stat-label { font-size: 0.6rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

/* TABS */
.tabs { display: flex; gap: 0; margin-bottom: 1.1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 4px; }

.tab {
  flex: 1; padding: 9px 10px; border-radius: 9px;
  font-family: var(--mono); font-size: 0.73rem; font-weight: 600;
  cursor: pointer; border: 1px solid transparent; background: transparent;
  color: var(--text2); transition: all 0.18s;
  display: flex; align-items: center; justify-content: center; gap: 7px;
}
.tab:hover:not(.active-danger):not(.active-success) { color: var(--text); }
.tab.active-danger { background: rgba(248,81,73,0.1); color: var(--danger); border-color: rgba(248,81,73,0.2); }
.tab.active-success { background: rgba(0,217,163,0.09); color: var(--accent); border-color: rgba(0,217,163,0.2); }

.tab-badge { font-size: 0.58rem; padding: 2px 6px; border-radius: 99px; font-weight: 700; line-height: 1.4; background: var(--surface2); color: var(--text2); }
.tab.active-danger .tab-badge { background: rgba(248,81,73,0.18); color: var(--danger); }
.tab.active-success .tab-badge { background: rgba(0,217,163,0.16); color: var(--accent); }

/* PANEL */
.panel { display: none; }
.panel.active { display: block; }

/* BULK BAR */
.bulk-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 0.9rem; flex-wrap: wrap; }
.bulk-status { font-family: var(--mono); font-size: 0.7rem; color: var(--text2); }

/* FILTER */
.filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 0.8rem; }
.filter-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--r); padding: 7px 12px; color: var(--text); font-family: var(--mono); font-size: 0.75rem; outline: none; transition: border-color 0.2s; }
.filter-input:focus { border-color: var(--accent); }
.filter-input::placeholder { color: var(--text3); }
.sort-sel { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--r); padding: 7px 10px; color: var(--text); font-family: var(--mono); font-size: 0.7rem; outline: none; cursor: pointer; }

/* SECTION TITLE */
.section-title { font-family: var(--mono); font-size: 0.62rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.7rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.section-count { color: var(--accent); }

/* USER CARDS */
.user-list { display: flex; flex-direction: column; gap: 5px; }

.user-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 9px 13px;
  display: flex; align-items: center; gap: 11px;
  transition: border-color 0.25s, opacity 0.3s;
  animation: slideUp 0.22s ease both;
}
@keyframes slideUp { from { opacity:0; transform:translateY(7px); } to { opacity:1; transform:none; } }
.user-card:hover { border-color: var(--border2); }
.user-card.card-done-uf { opacity: 0.38; border-color: transparent; }
.user-card.card-done-fb { opacity: 0.4; border-color: rgba(0,217,163,0.2); }
.user-card.card-err { border-color: rgba(248,81,73,0.28); }

.avatar { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--border); flex-shrink: 0; object-fit: cover; background: var(--surface2); }
.user-info { flex: 1; min-width: 0; }
.user-login { font-family: var(--mono); font-size: 0.82rem; font-weight: 600; color: var(--blue); text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: color 0.15s; }
.user-login:hover { color: #6db1ff; }
.user-name { font-size: 0.7rem; color: var(--text2); margin-top: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.badge { font-family: var(--mono); font-size: 0.57rem; padding: 3px 7px; border-radius: 4px; flex-shrink: 0; white-space: nowrap; }
.badge-danger  { background: rgba(248,81,73,0.09);  color: var(--danger);  border: 1px solid rgba(248,81,73,0.2);  }
.badge-fan     { background: rgba(255,166,87,0.1);   color: var(--warn);    border: 1px solid rgba(255,166,87,0.2); }
.badge-done-uf { background: rgba(248,81,73,0.07);   color: var(--text3);   border: 1px solid rgba(248,81,73,0.1);  }
.badge-done-fb { background: rgba(0,217,163,0.09);   color: var(--accent);  border: 1px solid rgba(0,217,163,0.2);  }

.action-btn {
  flex-shrink: 0; min-width: 84px; text-align: center;
  padding: 6px 12px; border-radius: 7px;
  font-family: var(--mono); font-weight: 600; font-size: 0.7rem;
  cursor: pointer; transition: all 0.15s; border: 1px solid; background: transparent;
}
.action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.ab-unfollow { color: var(--danger); border-color: var(--danger); }
.ab-unfollow:hover:not(:disabled) { background: rgba(248,81,73,0.1); }
.ab-follow   { color: var(--accent); border-color: var(--accent); }
.ab-follow:hover:not(:disabled)   { background: rgba(0,217,163,0.1); }
.ab-done     { color: var(--text3); border-color: var(--border2); }
.ab-retry    { color: var(--warn);  border-color: var(--warn); }
.ab-retry:hover:not(:disabled)    { background: rgba(255,166,87,0.1); }

/* EMPTY */
.empty { text-align: center; padding: 3rem 1rem; color: var(--text2); }
.empty .big { font-size: 2.8rem; margin-bottom: 0.6rem; }
.empty p { font-size: 0.82rem; }

#results { display: none; }

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

@keyframes spin { to { transform: rotate(360deg); } }
.spin-icon { display: inline-block; animation: spin 0.7s linear infinite; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-wrap">
      <svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
    </div>
    <div class="header-text">
      <h1>GitHub <span class="gr">Follow Manager</span></h1>
      <p>Clean non-followers &amp; follow back your fans ‚Äî all in one place</p>
    </div>
    <div class="header-pill">v3.0 ¬∑ no install needed</div>
  </div>

  <!-- CONFIG -->
  <div class="config-card">
    <div class="fields-row">
      <div class="field">
        <label>Personal Access Token</label>
        <div class="input-wrap">
          <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxx" autocomplete="off" spellcheck="false" />
          <button class="eye-btn" onclick="toggleVis()" title="Show / hide token">üëÅ</button>
        </div>
        <p class="hint">
          <a href="https://github.com/settings/tokens/new?scopes=read:user,user:follow" target="_blank">Create a token</a>
          ‚Äî tick <code>read:user</code> and <code>user:follow</code>
        </p>
      </div>
      <div class="field">
        <label>Your GitHub Username</label>
        <div class="input-wrap">
          <input type="text" id="usernameInput" placeholder="your-username" autocomplete="off" spellcheck="false" />
        </div>
        <p class="hint">Exact username shown on your profile page</p>
      </div>
    </div>

    <div class="config-actions">
      <button class="btn btn-primary" id="fetchBtn" onclick="startFetch()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Fetch &amp; Analyze
      </button>
      <button class="btn btn-ghost btn-sm" onclick="resetAll()">‚Ü∫ Reset</button>
    </div>

    <div class="progress-wrap" id="progressWrap" style="display:none">
      <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-label" id="progressLabel">Starting‚Ä¶</div>
    </div>
    <div class="error-box" id="errorBox"></div>
  </div>

  <!-- RESULTS -->
  <div id="results">

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-num" id="sFollowing" style="color:var(--blue)">‚Äî</div>
        <div class="stat-label">Following</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="sFollowers" style="color:var(--purple)">‚Äî</div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="sMutual" style="color:var(--accent)">‚Äî</div>
        <div class="stat-label">Mutual</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="sNonMutual" style="color:var(--danger)">‚Äî</div>
        <div class="stat-label">Not Following Back</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="sFans" style="color:var(--warn)">‚Äî</div>
        <div class="stat-label">Fans (unreciprocated)</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active-danger" id="tab-uf" onclick="switchTab('uf')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        Unfollow Non-Followers
        <span class="tab-badge" id="badge-uf">0</span>
      </button>
      <button class="tab" id="tab-fb" onclick="switchTab('fb')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Follow Back Fans
        <span class="tab-badge" id="badge-fb">0</span>
      </button>
    </div>

    <!-- UNFOLLOW PANEL -->
    <div class="panel active" id="panel-uf">
      <div class="bulk-bar">
        <button class="btn btn-danger btn-sm" id="btnUnfollowAll" onclick="bulkAction('uf')">‚ò† Unfollow All</button>
        <button class="btn btn-ghost btn-sm" id="btnStopUF" onclick="stopBulk('uf')" style="display:none">‚èπ Stop</button>
        <span class="bulk-status" id="statusUF"></span>
      </div>
      <div class="filter-row">
        <input class="filter-input" id="filterUF" type="text" placeholder="üîç  filter by username or name‚Ä¶" oninput="renderList('uf')" />
        <select class="sort-sel" id="sortUF" onchange="renderList('uf')">
          <option value="alpha">A‚ÄìZ</option>
          <option value="z">Z‚ÄìA</option>
          <option value="pending">Pending first</option>
        </select>
      </div>
      <div class="section-title">
        <span>You follow them ¬∑ they don't follow you</span>
        <span class="section-count" id="countUF"></span>
      </div>
      <div class="user-list" id="listUF"></div>
    </div>

    <!-- FOLLOW-BACK PANEL -->
    <div class="panel" id="panel-fb">
      <div class="bulk-bar">
        <button class="btn btn-success btn-sm" id="btnFollowAll" onclick="bulkAction('fb')">Ôºã Follow All Back</button>
        <button class="btn btn-ghost btn-sm" id="btnStopFB" onclick="stopBulk('fb')" style="display:none">‚èπ Stop</button>
        <span class="bulk-status" id="statusFB"></span>
      </div>
      <div class="filter-row">
        <input class="filter-input" id="filterFB" type="text" placeholder="üîç  filter by username or name‚Ä¶" oninput="renderList('fb')" />
        <select class="sort-sel" id="sortFB" onchange="renderList('fb')">
          <option value="alpha">A‚ÄìZ</option>
          <option value="z">Z‚ÄìA</option>
          <option value="pending">Pending first</option>
        </select>
      </div>
      <div class="section-title">
        <span>They follow you ¬∑ you don't follow them back</span>
        <span class="section-count" id="countFB"></span>
      </div>
      <div class="user-list" id="listFB"></div>
    </div>

  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sleep = ms => new Promise(r => setTimeout(r, ms));
const $     = id => document.getElementById(id);

let nonMutual   = [];   // following but they don't follow back
let notFollowed = [];   // they follow me but I don't follow back
let stUF = {};          // unfollow states: login ‚Üí '' | 'loading' | 'done' | 'error'
let stFB = {};          // follow-back states
let bulkUF = false, bulkFB = false;
let stopUF = false, stopFB = false;
let activeTab = 'uf';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setProgress(pct, msg) {
  $('progressFill').style.width = pct + '%';
  $('progressLabel').textContent = msg;
}
function showError(msg) { const e=$('errorBox'); e.textContent='‚ö†  '+msg; e.classList.add('show'); }
function hideError() { $('errorBox').classList.remove('show'); }
function toggleVis() { const i=$('tokenInput'); i.type = i.type==='password'?'text':'password'; }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function resetAll() {
  nonMutual=[]; notFollowed=[]; stUF={}; stFB={};
  bulkUF=bulkFB=stopUF=stopFB=false;
  $('results').style.display='none';
  $('progressWrap').style.display='none';
  $('fetchBtn').disabled=false;
  $('filterUF').value=''; $('filterFB').value='';
  hideError(); setProgress(0,'');
}

function updateCounters() {
  const pendUF = nonMutual.filter(u=>stUF[u.login]!=='done').length;
  const pendFB = notFollowed.filter(u=>stFB[u.login]!=='done').length;
  $('sNonMutual').textContent = pendUF;
  $('sFans').textContent      = pendFB;
  $('badge-uf').textContent   = pendUF;
  $('badge-fb').textContent   = pendFB;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  activeTab = tab;
  $('panel-uf').classList.toggle('active', tab==='uf');
  $('panel-fb').classList.toggle('active', tab==='fb');
  $('tab-uf').className = 'tab' + (tab==='uf' ? ' active-danger' : '');
  $('tab-fb').className = 'tab' + (tab==='fb' ? ' active-success' : '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GITHUB API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ghFetch(path, token, method='GET') {
  const res = await fetch('https://api.github.com' + path, {
    method,
    headers: { Authorization: 'token '+token, Accept: 'application/vnd.github.v3+json' },
  });

  if (method==='DELETE') {
    if (res.status===204) return {ok:true};
    const b = await res.json().catch(()=>({}));
    throw new Error(b.message || 'Unfollow failed ('+res.status+')');
  }
  if (method==='PUT') {
    if (res.status===204||res.status===200) return {ok:true};
    const b = await res.json().catch(()=>({}));
    throw new Error(b.message || 'Follow failed ('+res.status+')');
  }

  const data = await res.json();
  if (!res.ok) throw new Error(data.message || 'GitHub error '+res.status);
  return data;
}

async function fetchAllPages(path, token, onPage) {
  let out=[], page=1;
  while (true) {
    if (onPage) onPage(page, out.length);
    const batch = await ghFetch(path+'?per_page=100&page='+page, token);
    if (!Array.isArray(batch)||batch.length===0) break;
    out = out.concat(batch);
    if (batch.length<100) break;
    page++;
    await sleep(120);
  }
  return out;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN FETCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startFetch() {
  const token    = $('tokenInput').value.trim();
  const username = $('usernameInput').value.trim();
  hideError();
  if (!token||!username) { showError('Enter both your token and username first.'); return; }

  resetAll();
  $('fetchBtn').disabled = true;
  $('progressWrap').style.display = 'block';
  setProgress(3, 'Connecting to GitHub‚Ä¶');

  try {
    const following = await fetchAllPages(
      '/users/'+username+'/following', token,
      (p,n) => setProgress(Math.min(5+p*9,44), `Fetching following‚Ä¶ page ${p} (${n} users)`)
    );

    setProgress(46, `Got ${following.length} following. Fetching followers‚Ä¶`);

    const followers = await fetchAllPages(
      '/users/'+username+'/followers', token,
      (p,n) => setProgress(Math.min(50+p*9,88), `Fetching followers‚Ä¶ page ${p} (${n} users)`)
    );

    setProgress(95, 'Computing relationships‚Ä¶');
    await sleep(150);

    const followingSet = new Set(following.map(u=>u.login));
    const followerSet  = new Set(followers.map(u=>u.login));

    nonMutual   = following.filter(u => !followerSet.has(u.login));
    notFollowed = followers.filter(u => !followingSet.has(u.login));
    const mutual = following.filter(u => followerSet.has(u.login)).length;

    $('sFollowing').textContent = following.length;
    $('sFollowers').textContent = followers.length;
    $('sMutual').textContent    = mutual;
    $('sNonMutual').textContent = nonMutual.length;
    $('sFans').textContent      = notFollowed.length;
    $('badge-uf').textContent   = nonMutual.length;
    $('badge-fb').textContent   = notFollowed.length;

    setProgress(100, `‚úì Analyzed! ${nonMutual.length} non-followers ¬∑ ${notFollowed.length} fans waiting`);
    $('results').style.display = 'block';
    renderList('uf');
    renderList('fb');

  } catch(e) {
    showError(e.message);
    setProgress(0,'');
  } finally {
    $('fetchBtn').disabled = false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList(tab) {
  const isUF    = tab==='uf';
  const data    = isUF ? nonMutual : notFollowed;
  const states  = isUF ? stUF : stFB;
  const filtVal = ($( isUF?'filterUF':'filterFB').value||'').toLowerCase();
  const sortVal = $( isUF?'sortUF':'sortFB').value;
  const listEl  = $( isUF?'listUF':'listFB');
  const countEl = $( isUF?'countUF':'countFB');
  const bulkBtn = $( isUF?'btnUnfollowAll':'btnFollowAll');
  const isBulkRunning = isUF ? bulkUF : bulkFB;

  let list = data.filter(u =>
    !filtVal ||
    u.login.toLowerCase().includes(filtVal) ||
    (u.name||'').toLowerCase().includes(filtVal)
  );

  if (sortVal==='alpha')   list.sort((a,b)=>a.login.localeCompare(b.login));
  if (sortVal==='z')       list.sort((a,b)=>b.login.localeCompare(a.login));
  if (sortVal==='pending') list.sort((a,b)=>{
    return (states[a.login]==='done'?1:0) - (states[b.login]==='done'?1:0);
  });

  const pending = data.filter(u=>states[u.login]!=='done').length;
  countEl.textContent = list.length + ' shown';
  bulkBtn.disabled = isBulkRunning || pending===0;

  if (isUF) bulkBtn.textContent = isBulkRunning ? '‚è≥ Running‚Ä¶' : `‚ò† Unfollow All (${pending})`;
  else      bulkBtn.textContent = isBulkRunning ? '‚è≥ Running‚Ä¶' : `Ôºã Follow All Back (${pending})`;

  if (list.length===0) {
    listEl.innerHTML = data.length===0
      ? `<div class="empty"><div class="big">${isUF?'üéâ':'üíö'}</div><p>${isUF?'Everyone follows you back!':'You follow everyone who follows you!'}</p></div>`
      : `<div class="empty"><div class="big">üîç</div><p>No matches for your filter.</p></div>`;
    return;
  }

  listEl.innerHTML = list.map((u,i) => {
    const st   = states[u.login]||'';
    const done = st==='done', busy=st==='loading', err=st==='error';

    let btnLabel, btnClass;
    if (busy) { btnLabel='<span class="spin-icon">‚ü≥</span>'; btnClass='ab-done'; }
    else if (done) { btnLabel = isUF?'‚úì Removed':'‚úì Following'; btnClass='ab-done'; }
    else if (err)  { btnLabel = 'Retry'; btnClass='ab-retry'; }
    else           { btnLabel = isUF?'Unfollow':'Ôºã Follow'; btnClass = isUF?'ab-unfollow':'ab-follow'; }

    const cardClass = done ? (isUF?'card-done-uf':'card-done-fb') : err?'card-err':'';

    let badgeHtml;
    if (done) badgeHtml = isUF
      ? '<span class="badge badge-done-uf">‚úì unfollowed</span>'
      : '<span class="badge badge-done-fb">‚úì following</span>';
    else badgeHtml = isUF
      ? '<span class="badge badge-danger">not following back</span>'
      : '<span class="badge badge-fan">your fan</span>';

    const action = isUF ? `doAction('uf','${escHtml(u.login)}')` : `doAction('fb','${escHtml(u.login)}')`;

    return `
      <div class="user-card ${cardClass}" id="card-${tab}-${escHtml(u.login)}" style="animation-delay:${Math.min(i*.02,.5)}s">
        <img class="avatar" src="${escHtml(u.avatar_url)}&s=80" alt="" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2238%22 height=%2238%22><rect width=%2238%22 height=%2238%22 fill=%22%231a2332%22/></svg>'" />
        <div class="user-info">
          <a class="user-login" href="${escHtml(u.html_url)}" target="_blank" rel="noopener">@${escHtml(u.login)}</a>
          ${u.name?`<div class="user-name">${escHtml(u.name)}</div>`:''}
        </div>
        ${badgeHtml}
        <button class="action-btn ${btnClass}" id="btn-${tab}-${escHtml(u.login)}" onclick="${action}" ${done||busy?'disabled':''}>${btnLabel}</button>
      </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SINGLE ACTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doAction(tab, login) {
  const token = $('tokenInput').value.trim();
  if (!token) { showError('Token missing ‚Äî please re-enter.'); return; }

  const isUF   = tab==='uf';
  const states = isUF ? stUF : stFB;
  states[login]='loading';

  const btn  = $(`btn-${tab}-${login}`);
  const card = $(`card-${tab}-${login}`);
  if (btn) { btn.innerHTML='<span class="spin-icon">‚ü≥</span>'; btn.disabled=true; btn.className='action-btn ab-done'; }

  try {
    if (isUF) await ghFetch('/user/following/'+login, token, 'DELETE');
    else      await ghFetch('/user/following/'+login, token, 'PUT');

    states[login]='done';

    if (card) {
      card.classList.remove('card-err');
      card.classList.add(isUF?'card-done-uf':'card-done-fb');
      const badge = card.querySelector('.badge');
      if (badge) {
        badge.textContent = isUF?'‚úì unfollowed':'‚úì following';
        badge.className   = isUF?'badge badge-done-uf':'badge badge-done-fb';
      }
    }
    if (btn) { btn.textContent = isUF?'‚úì Removed':'‚úì Following'; btn.className='action-btn ab-done'; }
    updateCounters();
    // update bulk button text
    renderList(tab); // lightweight re-render for counts

  } catch(e) {
    states[login]='error';
    if (card) card.classList.add('card-err');
    if (btn) { btn.textContent='Retry'; btn.className='action-btn ab-retry'; btn.disabled=false; }
    showError(`Could not ${isUF?'unfollow':'follow'} @${login}: ${e.message}`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BULK ACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function bulkAction(tab) {
  const isUF = tab==='uf';
  if (isUF?bulkUF:bulkFB) return;

  if (isUF) { bulkUF=true; stopUF=false; } else { bulkFB=true; stopFB=false; }

  const stopBtn   = $(isUF?'btnStopUF':'btnStopFB');
  const statusEl  = $(isUF?'statusUF':'statusFB');
  const bulkBtn   = $(isUF?'btnUnfollowAll':'btnFollowAll');
  const data      = isUF ? nonMutual : notFollowed;
  const states    = isUF ? stUF : stFB;

  stopBtn.style.display='inline-flex';
  bulkBtn.disabled=true;
  statusEl.textContent='';

  const pending = data.filter(u=>states[u.login]!=='done');

  for (let i=0; i<pending.length; i++) {
    const shouldStop = isUF ? stopUF : stopFB;
    if (shouldStop) { statusEl.textContent='‚èπ Stopped.'; break; }
    statusEl.textContent = `${isUF?'Unfollowing':'Following'} ${i+1} / ${pending.length}‚Ä¶`;
    await doAction(tab, pending[i].login);
    await sleep(680);
  }

  const finalStop = isUF ? stopUF : stopFB;
  if (!finalStop) statusEl.textContent = `‚úì Done! ${isUF?'Unfollowed':'Followed back'} ${pending.length} users.`;

  if (isUF) { bulkUF=false; } else { bulkFB=false; }
  stopBtn.style.display='none';
  renderList(tab);
}

function stopBulk(tab) {
  const isUF = tab==='uf';
  if (isUF) { stopUF=true; $('statusUF').textContent='Stopping after this one‚Ä¶'; }
  else      { stopFB=true; $('statusFB').textContent='Stopping after this one‚Ä¶'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KEYBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  if (e.key==='Enter' && ['tokenInput','usernameInput'].includes(e.target.id)) startFetch();
});
</script>
</body>
</html>
